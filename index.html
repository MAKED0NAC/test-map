<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Navigacija</title>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet"
 href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
html,body{margin:0;height:100%;background:black;}
#map{height:100vh;width:100vw;}

/* rotacija mape */
.leaflet-map-pane{
  transition: transform 0.3s linear;
}

.navbox{
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:999;
}
input{padding:10px;border:none;}
button{padding:10px;background:#222;color:white;border:none;}
</style>
</head>
<body>

<div class="navbox">
<input id="dest" placeholder="Unesi destinaciju">
<button onclick="startNav()">Navigiraj</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
let map=L.map('map',{zoomControl:false}).setView([45,15],6);

L.tileLayer(
'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
).addTo(map);

let control;
let routeCoords=[];
let userLatLng;

// ===== SNAP NA RUTU =====
function snapToRoute(pos){

if(!routeCoords.length) return pos;

let closest=null;
let minDist=Infinity;

routeCoords.forEach(p=>{
  let d=map.distance(pos,[p.lat,p.lng]);
  if(d<minDist){
    minDist=d;
    closest=[p.lat,p.lng];
  }
});

return closest || pos;
}

// ===== GPS PRAÄ†ENJE =====
navigator.geolocation.watchPosition(pos=>{

let latlng=[pos.coords.latitude,pos.coords.longitude];
userLatLng=snapToRoute(latlng);

// centriraj mapu
map.setView(userLatLng,17,{animate:true});

// auto rotate mapa
if(pos.coords.heading!==null){
 let angle=360-pos.coords.heading;
 document.querySelector('.leaflet-map-pane')
 .style.transform=`rotate(${angle}deg)`;
}

},{
 enableHighAccuracy:true,
 maximumAge:0,
 timeout:5000
});

// ===== START NAVIGACIJE =====
function startNav(){

let dest=document.getElementById("dest").value;

fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${dest}`)
.then(res=>res.json())
.then(data=>{

let destLatLng=[data[0].lat,data[0].lon];

if(control) map.removeControl(control);

control=L.Routing.control({
 waypoints:[
  L.latLng(userLatLng),
  L.latLng(destLatLng)
 ],
 routeWhileDragging:false
}).addTo(map);

// spremi rutu za snap
control.on('routesfound', e=>{
 routeCoords=e.routes[0].coordinates;
});

});
}
</script>
</body>
</html>
